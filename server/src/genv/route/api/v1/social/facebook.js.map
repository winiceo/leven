{"version":3,"sources":["route/api/v1/social/facebook.js"],"names":[],"mappings":"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","file":"route/api/v1/social/facebook.js","sourcesContent":["var passport = require('passport');\nvar strategy = require('passport-facebook').Strategy;\nvar async    = require('async');\nvar _        = require('underscore');\n\nmodule.exports = function(app) {\n\n    var _env     = app.get('env');\n    var _mdl     = app.middle;\n    var _schema  = app.lib.schema;\n    var _conf    = app.config[_env].social;\n    var _emitter = app.lib.schemaEmitter;\n    var _group   = 'AUTH:SOCIAL:FACEBOOK';\n    \n    /**\n     * init passport facebook\n     */\n\n    _.each(_conf, function(value, key) {\n        var project = key;\n\n        if( ! value.facebook || ! value.facebook.enable )\n            return;\n\n        var facebook = value.facebook;\n\n        passport.use(new strategy({\n            clientID: facebook.key,\n            clientSecret: facebook.secret,\n            callbackURL: facebook.callback,\n            passReqToCallback : true\n        },\n        function(req, accessToken, refreshToken, profile, done) {\n            var project = req.params.project;\n\n            new _schema('system.apps').init(app).get({\n                slug: project,\n                qt: 'one'\n            }, function(err, apps) {\n                if(err) {\n                    _log.info(_group, 'app not found');\n                    return done(null);\n                }\n\n                new _schema('system.accounts').init(app).get({\n                    apps: apps._id.toString(),\n                    user_id: parseInt(profile.id),\n                    qt: 'one'\n                }, function(err, account) {\n\n                    if(err) {\n                        if(err.name != 'NotFound')\n                            return done(null);\n                    }\n\n                    if( ! req.session.social )\n                        req.session.social = {};\n\n                    var profilePhoto = 'http://graph.facebook.com/'+profile.id+'/picture?type=square';\n                    var sessionObj   = {\n                        network_id: parseInt(profile.id),\n                        network_id_str: profile.id,\n                        user_name: profile.username || '',\n                        display_name: profile.displayName || '',\n                        profile_photo: profilePhoto,\n                        token: accessToken,\n                        refresh_token: refreshToken || ''\n                    };\n                    \n                    if( ! account ) {\n                        new _schema('system.accounts').init(app).post({\n                            apps: apps._id.toString(),\n                            type: 'F',\n                            user_id: parseInt(profile.id),\n                            user_id_str: profile.id,\n                            user_name: profile.username || '',\n                            display_name: profile.displayName || '',\n                            profile_photo: 'http://graph.facebook.com/'+profile.id+'/picture?type=square',\n                            token: accessToken,\n                            refresh_token: refreshToken || '',\n                        }, function(err, doc) {\n                            if(err) {\n                                console.log(err);\n                                return done(null);\n                            }\n\n                            sessionObj.account_id = doc._id.toString();\n                            req.session.social.facebook = sessionObj;\n                            _emitter.emit('facebook_connected', sessionObj);\n\n                            done(null, {facebook: {}});\n                        });\n                    }\n                    else {\n                        new _schema('system.accounts').init(app).put(account._id.toString(), {\n                            user_name: profile.username || '',\n                            display_name: profile.displayName || '',\n                            profile_photo: 'http://graph.facebook.com/'+profile.id+'/picture?type=square',\n                            token: accessToken\n                        }, function(err, affected) {\n                            sessionObj.account_id = account._id.toString();\n                            req.session.social.facebook = sessionObj;\n                            _emitter.emit('facebook_connected', sessionObj);\n\n                            done(null, {facebook: {}});\n                        });\n                    }\n                });\n            });\n        }));\n\n        app.get('/api/:project/auth/facebook', passport.authenticate('facebook'));\n\n        app.get('/api/:project/facebook/callback', passport.authenticate('facebook', {\n            successRedirect: facebook.success,\n            failureRedirect: facebook.failure\n        }));\n\n    });\n\n};"],"sourceRoot":"/deploy/kevio/kevio/es6"}