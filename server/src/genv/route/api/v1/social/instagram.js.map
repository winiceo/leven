{"version":3,"sources":["route/api/v1/social/instagram.js"],"names":[],"mappings":"AAAA,IAAI,WAAW,QAAQ,UAAR,CAAf;AACA,IAAI,WAAW,QAAQ,oBAAR,EAA8B,QAA7C;AACA,IAAI,QAAW,QAAQ,OAAR,CAAf;AACA,IAAI,MAAW,QAAQ,OAAR,CAAf;AACA,IAAI,IAAW,QAAQ,YAAR,CAAf;;AAGA,OAAO,OAAP,GAAiB,UAAS,GAAT,EAAc;;AAE3B,QAAI,OAAW,IAAI,GAAJ,CAAQ,KAAR,CAAf;AACA,QAAI,OAAW,IAAI,MAAnB;AACA,QAAI,UAAW,IAAI,GAAJ,CAAQ,MAAvB;AACA,QAAI,QAAW,IAAI,MAAJ,CAAW,IAAX,EAAiB,MAAhC;AACA,QAAI,WAAW,IAAI,GAAJ,CAAQ,aAAvB;AACA,QAAI,SAAW,uBAAf;;AAEA;;;;AAIA,MAAE,IAAF,CAAO,KAAP,EAAc,UAAS,KAAT,EAAgB,GAAhB,EAAqB;AAC/B,YAAI,UAAU,GAAd;;AAEA,YAAI,CAAE,MAAM,SAAR,IAAqB,CAAE,MAAM,SAAN,CAAgB,MAA3C,EACI;;AAEJ,YAAI,YAAY,MAAM,SAAtB;;AAEA,iBAAS,GAAT,CAAa,IAAI,QAAJ,CAAa;AACtB,sBAAU,UAAU,GADE;AAEtB,0BAAc,UAAU,MAFF;AAGtB,yBAAa,UAAU,QAHD;AAItB,+BAAoB;AAJE,SAAb,EAMb,UAAS,GAAT,EAAc,WAAd,EAA2B,YAA3B,EAAyC,OAAzC,EAAkD,IAAlD,EAAwD;AACpD,gBAAI,UAAU,IAAI,MAAJ,CAAW,OAAzB;;AAEA,gBAAI,OAAJ,CAAY,aAAZ,EAA2B,IAA3B,CAAgC,GAAhC,EAAqC,GAArC,CAAyC;AACrC,sBAAM,OAD+B;AAErC,oBAAI;AAFiC,aAAzC,EAGG,UAAS,GAAT,EAAc,IAAd,EAAoB;AACnB,oBAAG,GAAH,EAAQ;AACJ,yBAAK,IAAL,CAAU,MAAV,EAAkB,eAAlB;AACA,2BAAO,KAAK,IAAL,CAAP;AACH;;AAED,oBAAI,OAAJ,CAAY,iBAAZ,EAA+B,IAA/B,CAAoC,GAApC,EAAyC,GAAzC,CAA6C;AACzC,0BAAM,KAAK,GAAL,CAAS,QAAT,EADmC;AAEzC,6BAAS,SAAS,QAAQ,EAAjB,CAFgC;AAGzC,wBAAI;AAHqC,iBAA7C,EAIG,UAAS,GAAT,EAAc,OAAd,EAAuB;;AAEtB,wBAAG,GAAH,EAAQ;AACJ,4BAAG,IAAI,IAAJ,IAAY,UAAf,EACI,OAAO,KAAK,IAAL,CAAP;AACP;;AAED,wBAAI,CAAE,IAAI,OAAJ,CAAY,MAAlB,EACI,IAAI,OAAJ,CAAY,MAAZ,GAAqB,EAArB;;AAEJ,wBAAI,eAAe,IAAI,GAAJ,CAAQ,OAAR,EAAiB,4BAAjB,KAAkD,EAArE;AACA,wBAAI,aAAe;AACf,oCAAY,SAAS,QAAQ,EAAjB,CADG;AAEf,wCAAgB,QAAQ,EAFT;AAGf,mCAAW,QAAQ,QAAR,IAAoB,EAHhB;AAIf,sCAAc,QAAQ,WAAR,IAAuB,EAJtB;AAKf,uCAAe,YALA;AAMf,+BAAO,WANQ;AAOf,uCAAe;AAPA,qBAAnB;;AAUA,wBAAI,CAAE,OAAN,EAAgB;AACZ,4BAAI,OAAJ,CAAY,iBAAZ,EAA+B,IAA/B,CAAoC,GAApC,EAAyC,IAAzC,CAA8C;AAC1C,kCAAM,KAAK,GAAL,CAAS,QAAT,EADoC;AAE1C,kCAAM,GAFoC;AAG1C,qCAAS,SAAS,QAAQ,EAAjB,CAHiC;AAI1C,yCAAa,QAAQ,EAJqB;AAK1C,uCAAW,QAAQ,QALuB;AAM1C,0CAAc,QAAQ,WANoB;AAO1C,2CAAe,YAP2B;AAQ1C,mCAAO,WARmC;AAS1C,2CAAe;AAT2B,yBAA9C,EAUG,UAAS,GAAT,EAAc,GAAd,EAAmB;AAClB,gCAAG,GAAH,EAAQ;AACJ,wCAAQ,GAAR,CAAY,GAAZ;AACA,uCAAO,KAAK,IAAL,CAAP;AACH;;AAED,uCAAW,UAAX,GAAwB,IAAI,GAAJ,CAAQ,QAAR,EAAxB;AACA,gCAAI,OAAJ,CAAY,MAAZ,CAAmB,SAAnB,GAA+B,UAA/B;AACA,qCAAS,IAAT,CAAc,qBAAd,EAAqC,UAArC;;AAEA,iCAAK,IAAL,EAAW,EAAC,WAAW,EAAZ,EAAX;AACH,yBArBD;AAsBH,qBAvBD,MAwBK;AACD,4BAAI,OAAJ,CAAY,iBAAZ,EAA+B,IAA/B,CAAoC,GAApC,EAAyC,GAAzC,CAA6C,QAAQ,GAAR,CAAY,QAAZ,EAA7C,EAAqE;AACjE,uCAAW,QAAQ,QAD8C;AAEjE,0CAAc,QAAQ,WAF2C;AAGjE,2CAAe,IAAI,GAAJ,CAAQ,OAAR,EAAiB,4BAAjB,CAHkD;AAIjE,mCAAO;AAJ0D,yBAArE,EAKG,UAAS,GAAT,EAAc,QAAd,EAAwB;AACvB,uCAAW,UAAX,GAAwB,QAAQ,GAAR,CAAY,QAAZ,EAAxB;AACA,gCAAI,OAAJ,CAAY,MAAZ,CAAmB,SAAnB,GAA+B,UAA/B;AACA,qCAAS,IAAT,CAAc,qBAAd,EAAqC,UAArC;;AAEA,iCAAK,IAAL,EAAW,EAAC,WAAW,EAAZ,EAAX;AACH,yBAXD;AAYH;AACJ,iBA/DD;AAgEH,aAzED;AA0EH,SAnFY,CAAb;;AAqFA,YAAI,GAAJ,CAAQ,8BAAR,EAAwC,SAAS,YAAT,CAAsB,WAAtB,CAAxC;;AAEA,YAAI,GAAJ,CAAQ,kCAAR,EAA4C,SAAS,YAAT,CAAsB,WAAtB,EAAmC;AAC3E,6BAAiB,UAAU,OADgD;AAE3E,6BAAiB,UAAU;AAFgD,SAAnC,CAA5C;AAKH,KApGD;AAsGH,CAnHD","file":"route/api/v1/social/instagram.js","sourcesContent":["var passport = require('passport');\nvar strategy = require('passport-instagram').Strategy;\nvar async    = require('async');\nvar dot      = require('dotty');\nvar _        = require('underscore');\n\n\nmodule.exports = function(app) {\n\n    var _env     = app.get('env');\n    var _mdl     = app.middle;\n    var _schema  = app.lib.schema;\n    var _conf    = app.config[_env].social;\n    var _emitter = app.lib.schemaEmitter;\n    var _group   = 'AUTH:SOCIAL:INSTAGRAM';\n    \n    /**\n     * init passport instagram\n     */\n\n    _.each(_conf, function(value, key) {\n        var project = key;\n\n        if( ! value.instagram || ! value.instagram.enable )\n            return;\n\n        var instagram = value.instagram;\n\n        passport.use(new strategy({\n            clientID: instagram.key,\n            clientSecret: instagram.secret,\n            callbackURL: instagram.callback,\n            passReqToCallback : true\n        },\n        function(req, accessToken, refreshToken, profile, done) {\n            var project = req.params.project;\n\n            new _schema('system.apps').init(app).get({\n                slug: project,\n                qt: 'one'\n            }, function(err, apps) {\n                if(err) {\n                    _log.info(_group, 'app not found');\n                    return done(null);\n                }\n\n                new _schema('system.accounts').init(app).get({\n                    apps: apps._id.toString(),\n                    user_id: parseInt(profile.id),\n                    qt: 'one'\n                }, function(err, account) {\n\n                    if(err) {\n                        if(err.name != 'NotFound')\n                            return done(null);\n                    }\n\n                    if( ! req.session.social )\n                        req.session.social = {};\n\n                    var profilePhoto = dot.get(profile, '_json.data.profile_picture') || '';\n                    var sessionObj   = {\n                        network_id: parseInt(profile.id),\n                        network_id_str: profile.id,\n                        user_name: profile.username || '',\n                        display_name: profile.displayName || '',\n                        profile_photo: profilePhoto,\n                        token: accessToken,\n                        refresh_token: refreshToken\n                    };\n                    \n                    if( ! account ) {\n                        new _schema('system.accounts').init(app).post({\n                            apps: apps._id.toString(),\n                            type: 'I',\n                            user_id: parseInt(profile.id),\n                            user_id_str: profile.id,\n                            user_name: profile.username,\n                            display_name: profile.displayName,\n                            profile_photo: profilePhoto,\n                            token: accessToken,\n                            refresh_token: refreshToken,\n                        }, function(err, doc) {\n                            if(err) {\n                                console.log(err);\n                                return done(null);\n                            }\n\n                            sessionObj.account_id = doc._id.toString();\n                            req.session.social.instagram = sessionObj;\n                            _emitter.emit('instagram_connected', sessionObj);\n\n                            done(null, {instagram: {}});\n                        });\n                    }\n                    else {\n                        new _schema('system.accounts').init(app).put(account._id.toString(), {\n                            user_name: profile.username,\n                            display_name: profile.displayName,\n                            profile_photo: dot.get(profile, '_json.data.profile_picture'),\n                            token: accessToken\n                        }, function(err, affected) {\n                            sessionObj.account_id = account._id.toString();\n                            req.session.social.instagram = sessionObj;\n                            _emitter.emit('instagram_connected', sessionObj);\n\n                            done(null, {instagram: {}});\n                        });\n                    }\n                });\n            });\n        }));\n\n        app.get('/api/:project/auth/instagram', passport.authenticate('instagram'));\n\n        app.get('/api/:project/instagram/callback', passport.authenticate('instagram', {\n            successRedirect: instagram.success,\n            failureRedirect: instagram.failure\n        }));\n\n    });\n\n};"],"sourceRoot":"/deploy/kevio/kevio/es6"}