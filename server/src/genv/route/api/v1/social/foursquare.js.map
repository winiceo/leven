{"version":3,"sources":["route/api/v1/social/foursquare.js"],"names":[],"mappings":"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","file":"route/api/v1/social/foursquare.js","sourcesContent":["var passport = require('passport');\nvar strategy = require('passport-foursquare').Strategy;\nvar async    = require('async');\nvar dot      = require('dotty');\nvar _        = require('underscore');\n\nmodule.exports = function(app) {\n\n    var _env     = app.get('env');\n    var _mdl     = app.middle;\n    var _log     = app.lib.logger;\n    var _schema  = app.lib.schema;\n    var _conf    = app.config[_env].social;\n    var _emitter = app.lib.schemaEmitter;\n    var _group   = 'AUTH:SOCIAL:FOURSQUARE';\n\n    /**\n     * init passport foursquare\n     */\n\n    _.each(_conf, function(value, key) {\n        var project = key;\n\n        if( ! value.foursquare || ! value.foursquare.enable )\n            return;\n\n        var foursquare = value.foursquare;\n\n        passport.use(new strategy({\n            clientID: foursquare.key,\n            clientSecret: foursquare.secret,\n            callbackURL: foursquare.callback,\n            passReqToCallback : true\n        },\n        function(req, token, tokenSecret, profile, done) {\n            var project = req.params.project;\n\n            new _schema('system.apps').init(app).get({\n                slug: project,\n                qt: 'one'\n            }, function(err, apps) {\n                if(err) {\n                    _log.info(_group, 'app not found');\n                    return done(null);\n                }\n\n                profile = dot.get(profile, '_json.response.user');\n                    \n                new _schema('system.accounts').init(app).get({\n                    apps: apps._id.toString(),\n                    user_id: parseInt(profile.id),\n                    qt: 'one'\n                }, function(err, account) {\n\n                    if(err) {\n                        if(err.name != 'NotFound')\n                            return done(null);\n                    }\n\n                    if( ! req.session.social )\n                        req.session.social = {};\n                    \n                    // set display name\n                    var displayName = '';\n                    \n                    if(profile.firstName) {\n                        displayName += profile.firstName;\n                        \n                        if(profile.lastName)\n                            displayName += ' '+profile.lastName;\n                    }\n                    \n                    // set profile photo\n                    var profilePhoto = '';\n                    \n                    if(profile.photo && profile.photo.prefix && profile.photo.suffix)\n                        profilePhoto = profile.photo.prefix+'original'+profile.photo.suffix\n\n                    // set location\n                    var location = profile.homeCity || '';\n                    \n                    var sessionObj   = {\n                        network_id: parseInt(profile.id),\n                        network_id_str: profile.id,\n                        user_name: profile.id,\n                        display_name: displayName,\n                        profile_photo: profilePhoto,\n                        location: location,\n                        token: token\n                    };\n                    \n                    if( ! account ) {\n                        new _schema('system.accounts').init(app).post({\n                            apps: apps._id.toString(),\n                            type: 'FS',\n                            user_id: parseInt(profile.id),\n                            user_id_str: profile.id,\n                            user_name: profile.id || '',\n                            display_name: displayName,\n                            profile_photo: profilePhoto,\n                            location: location,\n                            token: token\n                        }, function(err, doc) {\n                            if(err) {\n                                console.log(err);\n                                return done(null);\n                            }\n\n                            sessionObj.account_id = doc._id.toString();\n                            req.session.social.foursquare = sessionObj;\n                            _emitter.emit('foursquare_connected', sessionObj);\n\n                            done(null, {foursquare: {}});\n                        });\n                    }\n                    else {\n                        new _schema('system.accounts').init(app).put(account._id.toString(), {\n                            user_name: profile.id || '',\n                            display_name: displayName,\n                            profile_photo: profilePhoto,\n                            location: location,\n                            token: token\n                        }, function(err, affected) {\n                            sessionObj.account_id = account._id.toString();\n                            req.session.social.foursquare = sessionObj;\n                            _emitter.emit('foursquare_connected', sessionObj);\n\n                            done(null, {foursquare: {}});\n                        });\n                    }\n                });\n            });\n        }));\n\n        app.get('/api/:project/auth/foursquare', passport.authenticate('foursquare'));\n\n        app.get('/api/:project/foursquare/callback', passport.authenticate('foursquare', {\n            successRedirect: foursquare.success,\n            failureRedirect: foursquare.failure\n        }));\n\n    });\n\n};"],"sourceRoot":"/deploy/kevio/kevio/es6"}